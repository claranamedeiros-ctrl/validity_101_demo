# CSV Files Comparison Guide

## Why You Need to Upload CSVs to Railway

### Short Answer
**The `groundt/` folder is in `.gitignore` (line 50)**, so CSV files are **NEVER** pushed to GitHub or Railway automatically. You've always had to upload them manually!

## The Three CSV Files Explained

### 1. **Ground_truth.csv** (Original from Client)
- **Source:** Your client provided this
- **Format:** Human-readable with full names
- **Purpose:** Original data source
- **Location:** `groundt/Ground_truth.csv`

**Headers:**
```
Patent Number, Claim #, Claim Text, Abstract, Alice Step One, Alice Step Two, Overall Eligibility
```

**Sample Values:**
- Alice Step One: `"Abstract"`, `"Not Abstract"`, `"Natural Phenomenon"`
- Alice Step Two: `"No IC Found"`, `"IC Found"`, `"N/A"`
- Overall Eligibility: `"Eligible"`, `"Ineligible"`

### 2. **gt_transformed_for_llm.csv** (Transformed for Rails)
- **Source:** Generated by `scripts/transform_new_ground_truth.rb`
- **Format:** Machine-readable, matches LLM schema exactly
- **Purpose:** Used by Rails app for evaluation
- **Location:** `groundt/gt_transformed_for_llm.csv`

**Headers:**
```
patent_number, claim_number, claim_text, abstract, gt_subject_matter, gt_inventive_concept, gt_overall_eligibility
```

**Sample Values:**
- gt_subject_matter: `"Abstract"`, `"Not Abstract/Not Natural Phenomenon"`, `"Natural Phenomenon"`
- gt_inventive_concept: `"No"`, `"Yes"`, `"-"`
- gt_overall_eligibility: `"Eligible"`, `"Ineligible"`

### 3. **gt_aligned_normalized_test.csv** (OLD, no longer used)
- **Source:** Old transformation script (now deleted)
- **Format:** Outdated format with backend mapping
- **Purpose:** Used by OLD system with forced_value rules
- **Status:** ⚠️ REPLACED by gt_transformed_for_llm.csv

## Key Differences

### Ground_truth.csv vs gt_transformed_for_llm.csv

| Field | Client Version (Ground_truth.csv) | LLM Version (gt_transformed_for_llm.csv) |
|-------|-----------------------------------|------------------------------------------|
| **Header Style** | "Patent Number", "Claim #" | "patent_number", "claim_number" |
| **Alice Step One** | "Not Abstract" | "Not Abstract/Not Natural Phenomenon" |
| **Alice Step Two** | "No IC Found" | "No" |
| **Alice Step Two** | "IC Found" | "Yes" |
| **Alice Step Two** | "N/A" | "-" |

## Why Transform?

### Problem: LLM Schema Mismatch
The LLM (OpenAI GPT-4) is forced to use specific enum values by the schema:

```ruby
schema = {
  inventive_concept: {
    enum: ["No", "Yes", "-"]  # NOT "No IC Found", "IC Found", "N/A"!
  }
}
```

The client CSV says `"No IC Found"` but the LLM can **ONLY** output `"No"`, `"Yes"`, or `"-"`.

### Solution: Transform Ground Truth
Instead of transforming the LLM output (which hides what it actually said), we transform the ground truth to match what the LLM can actually output.

**Before (OLD system):**
```
Client CSV: "No IC Found"
    ↓
LLM outputs: "No"
    ↓
Backend forces: "uninventive" ❌ (hidden transformation)
    ↓
Compare: "uninventive" == "uninventive" ✅
```

**After (NEW system):**
```
Client CSV: "No IC Found"
    ↓
Transform script: "No IC Found" → "No"
    ↓
LLM outputs: "No"
    ↓
Compare: "No" == "No" ✅ (direct comparison, no hidden transforms)
```

## Which File Goes Where?

### Local Development
```
groundt/
├── Ground_truth.csv                  # Keep as reference
├── Ground_truth.csv.backup           # Auto-created backup
└── gt_transformed_for_llm.csv        # ⭐ USE THIS for Rails
```

### Railway Deployment
**Upload this file:**
```bash
railway run bash -c "mkdir -p /app/groundt && cat > /app/groundt/gt_transformed_for_llm.csv" < groundt/gt_transformed_for_llm.csv
```

**Rails code expects:**
```ruby
# app/controllers/prompt_engine/eval_sets_controller.rb:310
ground_truth_file = Rails.root.join('groundt', 'gt_transformed_for_llm.csv')
```

## Why Not Commit CSVs to Git?

### Reasons (from .gitignore line 50):

1. **Size** - 107KB files with full patent text are too large
2. **Proprietary Data** - Patent claim text might be sensitive
3. **Frequent Changes** - Ground truth evolves during development
4. **Environment-Specific** - Dev/staging/prod may use different datasets

## Summary Table

| File | Size | Purpose | In Git? | Upload to Railway? |
|------|------|---------|---------|-------------------|
| Ground_truth.csv | 107KB | Client original | ❌ No | ❌ No (keep as reference) |
| gt_transformed_for_llm.csv | 107KB | Rails evaluation | ❌ No | ✅ **YES - Upload this!** |
| Ground_truth.csv.backup | 107KB | Safety backup | ❌ No | ❌ No |

## How to Upload to Railway

### Option 1: Railway CLI (Recommended)
```bash
# Install if needed
npm install -g @railway/cli

# Login
railway login

# Link to project
railway link

# Upload CSV
cat groundt/gt_transformed_for_llm.csv | railway run bash -c "mkdir -p /app/groundt && cat > /app/groundt/gt_transformed_for_llm.csv"

# Verify
railway run ls -lh /app/groundt/
railway run head -2 /app/groundt/gt_transformed_for_llm.csv
```

### Option 2: Manual via Railway Shell
1. Go to Railway dashboard
2. Click on your service
3. Click "Shell" tab
4. Run: `mkdir -p /app/groundt`
5. Manually paste CSV content (not practical for 107KB file!)

## Common Questions

### Q: Why did the old system work without upload?
**A:** It didn't! You uploaded the old CSV before and forgot. The `groundt/` folder has ALWAYS been gitignored.

### Q: Can I commit the CSV to git now?
**A:** Not recommended. It's 107KB and contains proprietary data. Railway deployment should handle data separately from code.

### Q: What if I update Ground_truth.csv?
**A:** Run the transformation script again:
```bash
ruby scripts/transform_new_ground_truth.rb
# Then re-upload to Railway
```

### Q: Can Railway auto-sync the CSV?
**A:** No, because it's gitignored. This is intentional - data and code should be separate.

---

**Remember:** Always upload `gt_transformed_for_llm.csv` to Railway, NOT `Ground_truth.csv`!
